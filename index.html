<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Michelle’s Colony</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ff9fd0"/>
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <style>
    :root{
      --bg:#201629; --panel:#2a1e36; --muted:#c6b9d4; --text:#fff7fb;
      --accent:#ff9fd0; --warn:#ffd18a; --good:#b4f0c2; --bad:#ff8aa5;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#201629,#1b1323);color:var(--text);font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial,sans-serif}
    #app{display:grid;grid-template-rows:auto 1fr auto;min-height:100%}
    header,footer{padding:10px 12px;background:rgba(255,255,255,0.03);backdrop-filter:blur(6px);position:sticky;z-index:2}
    header{top:0} footer{bottom:0}
    h1{font-size:18px;margin:0;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .badge{font-size:12px;color:var(--bg);background:var(--accent);border-radius:999px;padding:2px 8px;}
    .content{padding:10px;display:grid;gap:10px;grid-template-columns:1fr;max-width:980px;margin:0 auto;width:100%}
    @media(min-width:900px){.content{grid-template-columns:1.2fr 1fr}}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,0.08);border-radius:14px;padding:12px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .stat{flex:1 1 120px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:8px 10px}
    .stat h3{margin:0 0 6px 0;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    .stat .val{font-variant-numeric:tabular-nums;font-size:18px}
    .btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);background:#3a2a4a;color:#fff;font-weight:600;user-select:none;-webkit-user-select:none;touch-action:manipulation}
    .btn:disabled{opacity:.5} .btn.accent{background:linear-gradient(180deg,#4b2f4b,#301b30)} .btn.warn{background:linear-gradient(180deg,#3a2a1a,#22170e)} .btn.good{background:linear-gradient(180deg,#1a3a1f,#0d2312)}
    .grid{display:grid;gap:8px} .grid.cols-2{grid-template-columns:1fr 1fr} .grid.cols-3{grid-template-columns:1fr 1fr 1fr; gap:10px}
    .label{font-size:12px;color:var(--muted)} .small{font-size:12px;color:var(--muted)} .sep{height:1px;background:rgba(255,255,255,0.06);margin:10px 0}
    .build-item{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:8px;border:1px solid rgba(255,255,255,0.08);border-radius:10px;background:rgba(255,255,255,0.03)}
    .count{font-size:12px;color:var(--muted)} .progress{height:6px;background:#24182e;border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,0.06)}
    .progress>div{height:100%;background:linear-gradient(90deg,var(--accent),#ffd1ec)}
    .tabs{display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap} .tab{flex:1;padding:10px;text-align:center;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.02);font-weight:600}
    .tab.active{background:linear-gradient(180deg,#3a2b4a,#2a1e36)}
    .bubble{position:fixed;top:60px;left:12px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);backdrop-filter:blur(6px);padding:8px 12px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.3);opacity:0;transition:opacity .2s, transform .2s, top .2s, left .2s;transform:translateY(-6px);z-index:5;font-size:13px;max-width:70vw; pointer-events:none }
    .bubble.show{opacity:1;transform:translateY(0)}
    #ending{position:fixed;inset:0;background:radial-gradient(circle at 50% 30%, rgba(255,159,208,.15), rgba(32,22,41,.95)), #1b1323;color:#fff;display:none;z-index:20;align-items:center;justify-content:center;padding:20px;text-align:center}
    #ending .panel{max-width:760px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.15);border-radius:18px;padding:18px;box-shadow:0 10px 40px rgba(0,0,0,.5)}
    #ending h2{margin-top:0}
    #ending .bigheart{font-size:44px}
    a{color:var(--accent);text-decoration:none}
  </style>
</head>
<body>
<div id="app">
  <header>
    <h1>
      🌸 Michelle’s Colony
      <span class="badge" id="badge">v1.2.5 Hotfix</span>
      <span class="badge" id="hlBadge" title="Total Heartlight">💞 <span id="hlHeader">0</span></span>
      <span class="badge" id="nickBadge" style="display:none"></span>
    </h1>
  </header>

  <div id="bubble" class="bubble" role="status" aria-live="polite"></div>

  <main class="content">
    <section class="card">
      <div class="row">
        <div class="stat"><h3>Sparkles ✨</h3><div class="val" id="energy">0</div><div class="small" id="eps">+0/s</div></div>
        <div class="stat"><h3>Charms 💖</h3><div class="val" id="ore">0</div><div class="small" id="ops">+0/s</div></div>
        <div class="stat"><h3>Treats 🍓</h3><div class="val" id="food">0</div><div class="small" id="fps">+0/s</div></div>
        <div class="stat"><h3>Petals 🌸</h3><div class="val" id="petals">0</div><div class="small" id="pps">+0/s</div></div>
        <div class="stat"><h3>Michelle’s 🐾</h3><div class="val" id="colonists">0 / 0</div><div class="small" id="morale">happiness: 100%</div></div>
        <div class="stat"><h3>Heartlight 💞</h3><div class="val" id="inspirationStat">0</div><div class="small">permanent</div></div>
      </div>
      <div style="margin-top:10px" class="grid cols-2">
        <button id="tapBtn" class="btn accent">Tap to Share Affection (+1 ✨)</button>
        <button id="hireBtn" class="btn good">Invite a Michelle (50 🍓)</button>
      </div>
      <div class="sep"></div>
      <div class="grid cols-3">
        <div><div class="label">Sparkle Jars</div><div class="progress"><div id="batteryFill" style="width:0%"></div></div><div class="small" id="capText">0 / 100</div></div>
        <div><div class="label">Charm Shelf</div><div class="progress"><div id="storeFill" style="width:0%"></div></div><div class="small" id="storeText">0 / 100</div></div>
        <div><div class="label">Treat Pantry</div><div class="progress"><div id="siloFill" style="width:0%"></div></div><div class="small" id="siloText">0 / 100</div></div>
        <div><div class="label">Petal Basket</div><div class="progress"><div id="petalFill" style="width:0%"></div></div><div class="small" id="petalText">0 / 100</div></div>
      </div>
      <div class="small" style="margin-top:10px">Tip: Build cozy spots and treat kitchens. Keep Treats up to keep happiness high. Michelle quests now show leaving and returning, with faster rhythm as your colony grows.</div>
    </section>

    <section class="card">
      <div class="tabs">
        <button class="tab active" id="tabBuild">Build</button>
        <button class="tab" id="tabUpg">Upgrades</button>
        <button class="tab" id="tabPrestige">Heartlight</button>
        <button class="tab" id="tabTree">Bond Tree</button>
        <button class="tab" id="tabSettings">Settings</button>
      </div>

      <div id="panelBuild">
        <div class="grid" id="buildList"></div>
      </div>

      <div id="panelUpg" style="display:none">
        <div class="grid" id="upgradeList"></div>
      </div>

      <div id="panelPrestige" style="display:none">
        <div class="small">Send a Love Beacon to celebrate your bond, resetting the island but keeping permanent <b>Heartlight</b> for lasting bonuses. The required resources increase a bit each time.</div>
        <div class="grid" style="margin-top:10px">
          <div class="build-item">
            <div class="left">
              <div>
                <div><b>Send Love Beacon</b> 🚀</div>
                <div class="small">Needs <span id="reqEnergy">0</span> ✨, <span id="reqOre">0</span> 💖, <span id="reqFood">0</span> 🍓, <span id="reqPetals">0</span> 🌸</div>
                <div class="small">Grants <span id="prestigeGain">0</span> Heartlight</div>
              </div>
            </div>
            <button id="prestigeBtn" class="btn warn">Celebrate (Reset)</button>
          </div>
          <div class="small">Total Heartlight: <b id="inspiration">0</b> (+<span id="inspBoost">0</span>% all glow)</div>
        </div>
      </div>

      <div id="panelTree" style="display:none">
        <div class="small">Spend <b>Heartlight</b> to unlock permanent bonuses. Fill the whole tree to see a special ending.</div>
        <div class="grid" id="treeList" style="margin-top:10px"></div>
      </div>

      <div id="panelSettings" style="display:none">
        <div class="grid">
          <button class="btn" id="saveBtn">Save Now</button>
          <button class="btn bad" id="wipeBtn">Wipe Save (reset)</button>
          <button class="btn" id="installBtn" style="display:none">Install Michelle’s Colony</button>
          <div class="small" id="saveInfo"></div>
        </div>
      </div>
    </section>

    <section class="card">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div><b>Moments</b></div>
        <button class="btn" id="exportBtn" style="max-width:200px">Export Save</button>
      </div>
      <div id="log" class="small" style="margin-top:8px;max-height:220px;overflow:auto;white-space:pre-wrap"></div>
    </section>
  </main>

  <footer><div class="small">Made with 💗. Add to Home Screen for full-screen play • Offline ready</div></footer>
</div>

<div id="ending"><div class="panel">
  <div class="bigheart">💞</div>
  <h2>Happily Ever After</h2>
  <p id="endingText"></p>
  <div style="margin-top:12px" class="grid cols-2">
    <button id="restartBtn" class="btn">Start a New Journey</button>
    <a class="btn" id="saveStoryBtn" download="michelles_epilogue.txt">Save Epilogue</a>
  </div>
</div></div>

<script>
const VERSION = '1.2.5-hotfix';
const SAVE_KEY = 'michelles_colony_save_v1';

let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; const btn = document.getElementById('installBtn'); if (btn) btn.style.display = 'block'; });
document.addEventListener('click', async (ev) => { if (ev.target && ev.target.id === 'installBtn' && deferredPrompt) { ev.target.disabled = true; try { deferredPrompt.prompt(); await deferredPrompt.userChoice; } finally { deferredPrompt = null; ev.target.style.display = 'none'; ev.target.disabled = false; } } });
window.addEventListener('appinstalled', () => { const btn = document.getElementById('installBtn'); if (btn) btn.style.display = 'none'; });

const defaultState = {
  tree: { levels: {} },
  resources: { energy: 0, ore: 0, food: 0, petals: 0 },
  capacity: { energy: 100, ore: 100, food: 100, petals: 100 },
  rates: { eps: 0, ops: 0, fps: 0, pps: 0 },
  buildings: {
    'Sun-Window Nook': { count: 0, baseCost: { ore: 10 }, costScale: 1.15, prod: { energy: 1 } },
    'Charm Garden':    { count: 0, baseCost: { energy: 30 }, costScale: 1.17, prod: { ore: 1.2 } },
    'Treat Kitchen':   { count: 0, baseCost: { ore: 20 }, costScale: 1.16, prod: { food: 0.6 } },
    'Flower Meadow':   { count: 0, baseCost: { energy: 40 }, costScale: 1.18, prod: { petals: 0.8 } },
    'Sparkle Jar':     { count: 0, baseCost: { ore: 40 }, costScale: 1.18, prod: { capEnergy: 120 } },
    'Snuggle Hall':    { count: 0, baseCost: { ore: 50 }, costScale: 1.18, prod: { capOre: 120 } },
    'Pantry':          { count: 0, baseCost: { ore: 50 }, costScale: 1.18, prod: { capFood: 120 } },
    'Greenhouse':      { count: 0, baseCost: { petals: 60 }, costScale: 1.20, prod: { capPetals: 120 } }
  },
  upgrades: {
    'Morning Coffee Ritual': { level:0, max:5, baseCost:{ ore:50 },   scale:1.8, effect:{ energyMult: 0.25 } },
    'Adventure Spark':       { level:0, max:5, baseCost:{ energy:80 },scale:1.8, effect:{ oreMult:    0.25 } },
    'Favorite Snacks':       { level:0, max:5, baseCost:{ ore:60 },   scale:1.8, effect:{ foodMult:   0.25 } },
    'Cozy Logistics':        { level:0, max:5, baseCost:{ ore:100 },  scale:2.0, effect:{ capAll:     0.25 } },
    'Evening Walks (T2)':    { level:0, max:5, baseCost:{ food:150 }, scale:2.0, effect:{ moraleFloor: 0.02 } },
    'Tap Mastery (T2)':      { level:0, max:5, baseCost:{ ore:200 },  scale:2.1, effect:{ tapMult:    0.50 } },
    'Petal Care (T2)':       { level:0, max:5, baseCost:{ petals:120 },scale:2.0, effect:{ petalsMult: 0.30 } }
  },
  colonists: { count: 0, morale: 1.0, housing: 0 },
  inspiration: 0,
  prestigeCount: 0,
  nextQuestAt: Date.now() + 45000,
  questActive: false,
  lastTick: Date.now(),
  offlineNote: '',
  log: [],
  won: false
};

const TREE_DEFS = {
  'Shared Laughs':      { max: 10, baseCost: 1, scale: 1.4, prereq: null, desc: '+10% ✨ Sparkles per level' },
  'Adventures Together':{ max: 10, baseCost: 1, scale: 1.4, prereq: 'Shared Laughs', desc: '+10% 💖 Charms per level' },
  'Favorite Snacks':    { max: 10, baseCost: 1, scale: 1.4, prereq: 'Adventures Together', desc: '+10% 🍓 Treats per level' },
  'Cozy Storage':       { max: 10, baseCost: 1, scale: 1.5, prereq: null, desc: '+10% capacity per level' },
  'Love Notes':         { max: 10, baseCost: 2, scale: 1.5, prereq: 'Shared Laughs', desc: '+1 tap affection power per level' },
  'Organized Nest':     { max: 10, baseCost: 2, scale: 1.5, prereq: 'Cozy Storage', desc: '-2% build & upgrade costs per level (to 50%)' },
  'Quiet Nights In':    { max: 8,  baseCost: 2, scale: 1.6, prereq: 'Favorite Snacks', desc: '+5% happiness floor per level' },
  'Room for Cuddles':   { max: 5,  baseCost: 3, scale: 1.7, prereq: 'Organized Nest', desc: '+1 housing per Snuggle Hall per level' },
  'Gentle Rhythm':      { max: 10, baseCost: 2, scale: 1.6, prereq: 'Love Notes', desc: '+0.5 ✨/s per level (auto glow)' },
  'Beating Hearts':     { max: 10, baseCost: 3, scale: 1.7, prereq: null, desc: '+5% Heartlight gain per level' },
  'Petal Dance':        { max: 10, baseCost: 2, scale: 1.6, prereq: 'Favorite Snacks', desc: '+10% 🌸 Petals per level' },
  'Questing Spirit':    { max: 10, baseCost: 3, scale: 1.6, prereq: null, desc: 'Quests +5% reward & +3% faster per level' },
  'Tap Mastery':        { max: 10, baseCost: 3, scale: 1.6, prereq: 'Love Notes', desc: '+0.5 tap power per level' }
};

function treeEffects(){
  const L = S.tree.levels || {};
  return {
    energyMult: 1 + 0.10*(L['Shared Laughs']||0),
    oreMult:    1 + 0.10*(L['Adventures Together']||0),
    foodMult:   1 + 0.10*(L['Favorite Snacks']||0),
    petalsMult: 1 + 0.10*(L['Petal Dance']||0),
    capMult:    1 + 0.10*(L['Cozy Storage']||0),
    tapBonus:        (L['Love Notes']||0)*1.0 + (L['Tap Mastery']||0)*0.5,
    discount:        Math.min(0.5, 0.02*(L['Organized Nest']||0)),
    moraleFloorBonus: 0.05*(L['Quiet Nights In']||0),
    extraHousingPerWarehouse: (L['Room for Cuddles']||0),
    autoEnergy:      0.5*(L['Gentle Rhythm']||0),
    inspBonus:       0.05*(L['Beating Hearts']||0),
    questRewardMult: 1 + 0.05*(L['Questing Spirit']||0),
    questSpeedMult:  1 + 0.03*(L['Questing Spirit']||0)
  };
}

function nicknameFor(count){
  if(count>=30) return "Heartlight Hive";
  if(count>=20) return "Cuddle Caravan";
  if(count>=10) return "Snuggle Squad";
  if(count>=5)  return "Cozy Crew";
  return "";
}

function fmt(n){ if(n>=1e9) return (n/1e9).toFixed(2)+'B'; if(n>=1e6) return (n/1e6).toFixed(2)+'M'; if(n>=1e3) return (n/1e3).toFixed(2)+'k'; return (Math.floor(n*100)/100).toLocaleString(); }
function icon(k){ return k==='energy'?'✨':k==='ore'?'💖':k==='food'?'🍓':k==='petals'?'🌸':k; }
function prodText(p){ const parts=[]; if(p.energy) parts.push('+'+p.energy+'/s ✨'); if(p.ore) parts.push('+'+p.ore+'/s 💖'); if(p.food) parts.push('+'+p.food+'/s 🍓'); if(p.petals) parts.push('+'+p.petals+'/s 🌸'); if(p.capEnergy) parts.push('+'+p.capEnergy+' cap ✨'); if(p.capOre) parts.push('+'+p.capOre+' cap 💖'); if(p.capFood) parts.push('+'+p.capFood+' cap 🍓'); if(p.capPetals) parts.push('+'+p.capPetals+' cap 🌸'); return parts.join(' • '); }
function addLog(msg){ const t=new Date().toLocaleTimeString(); S.log.unshift('['+t+'] '+msg); S.log=S.log.slice(0,300); renderLog(); }
function save(now=false){ S.lastTick=Date.now(); localStorage.setItem(SAVE_KEY, JSON.stringify(S)); if(now){ document.getElementById('saveInfo').textContent='Saved at '+new Date().toLocaleTimeString(); } }
function load(){ const raw=localStorage.getItem(SAVE_KEY); if(raw){ try{ S=JSON.parse(raw);}catch{S=structuredClone(defaultState);} }else{ S=structuredClone(defaultState);} S=Object.assign(structuredClone(defaultState), S); }
function reset(){ localStorage.removeItem(SAVE_KEY); S=structuredClone(defaultState); addLog('New run started.'); save(); renderAll(); }
function totalMult(){
  const tE = treeEffects();
  const insp = 1 + (S.inspiration * 0.02);
  let energyMult=1, oreMult=1, foodMult=1, petalsMult=1, capMult=1, tapMult=1, moraleFloor=0;
  for(const [name,u] of Object.entries(S.upgrades)){
    const lv=u.level;
    if(u.effect.energyMult) energyMult += lv*u.effect.energyMult;
    if(u.effect.oreMult)    oreMult    += lv*u.effect.oreMult;
    if(u.effect.foodMult)   foodMult   += lv*u.effect.foodMult;
    if(u.effect.petalsMult) petalsMult += lv*u.effect.petalsMult;
    if(u.effect.capAll)     capMult    += lv*u.effect.capAll;
    if(u.effect.tapMult)    tapMult    += lv*u.effect.tapMult;
    if(u.effect.moraleFloor)moraleFloor+= lv*u.effect.moraleFloor;
  }
  return {
    energyMult: energyMult*insp*tE.energyMult,
    oreMult:    oreMult*insp*tE.oreMult,
    foodMult:   foodMult*insp*tE.foodMult,
    petalsMult: petalsMult*insp*tE.petalsMult,
    capMult:    capMult*tE.capMult,
    tapAdd:     (tE.tapBonus||0),
    tapMult:    tapMult,
    moraleFloorBonus: (tE.moraleFloorBonus||0) + moraleFloor
  };
}
function recompute(){
  const tE = treeEffects();
  const mult = totalMult();
  let eps=0, ops=0, fps=0, pps=0;
  let capE=100, capO=100, capF=100, capP=100;
  for(const [name,b] of Object.entries(S.buildings)){
    const c=b.count; if(c<=0) continue;
    if(b.prod.energy)  eps += b.prod.energy*c*mult.energyMult;
    if(b.prod.ore)     ops += b.prod.ore*c*mult.oreMult;
    if(b.prod.food)    fps += b.prod.food*c*mult.foodMult;
    if(b.prod.petals)  pps += b.prod.petals*c*mult.petalsMult;
    if(b.prod.capEnergy){ const scale=1+0.10*Math.max(0,c-1); capE += b.prod.capEnergy*c*scale*mult.capMult; }
    if(b.prod.capOre){    const scale=1+0.10*Math.max(0,c-1); capO += b.prod.capOre*c*scale*mult.capMult; }
    if(b.prod.capFood){   const scale=1+0.10*Math.max(0,c-1); capF += b.prod.capFood*c*scale*mult.capMult; }
    if(b.prod.capPetals){ const scale=1+0.10*Math.max(0,c-1); capP += b.prod.capPetals*c*scale*mult.capMult; }
  }
  const colBoost = S.colonists.count * 0.05;
  eps += colBoost * mult.energyMult;
  ops += colBoost * 1.2 * mult.oreMult;
  fps += colBoost * mult.foodMult;
  pps += colBoost * 0.8 * mult.petalsMult;
  const moraleFloor = Math.min(0.95, 0.2 + mult.moraleFloorBonus);
  const foodPct = S.resources.food / Math.max(1, capF);
  const moraleTarget = Math.min(1, Math.max(moraleFloor, foodPct*1.2));
  S.colonists.morale = S.colonists.morale*0.9 + moraleTarget*0.1;
  const moraleMult = 0.5 + S.colonists.morale*0.5;
  eps *= moraleMult; ops *= moraleMult; fps *= moraleMult; pps *= moraleMult;
  S.rates.eps = eps + (tE.autoEnergy||0);
  S.rates.ops = ops; S.rates.fps = fps; S.rates.pps = pps;
  S.capacity.energy=Math.floor(capE); S.capacity.ore=Math.floor(capO); S.capacity.food=Math.floor(capF); S.capacity.petals=Math.floor(capP);
  const halls = (S.buildings['Snuggle Hall']?.count)||0; const per = 2 + (tE.extraHousingPerWarehouse||0); S.colonists.housing = halls * per;
  const nb = nicknameFor(S.colonists.count);
  const el = document.getElementById('nickBadge');
  if(nb){ el.textContent = nb; el.style.display='inline-block'; } else { el.style.display='none'; }
}
function tick(dt){
  if(S.won) return;
  S.resources.energy = Math.min(S.capacity.energy, S.resources.energy + S.rates.eps*dt);
  S.resources.ore    = Math.min(S.capacity.ore,    S.resources.ore    + S.rates.ops*dt);
  S.resources.food   = Math.min(S.capacity.food,   S.resources.food   + S.rates.fps*dt);
  S.resources.petals = Math.min(S.capacity.petals, S.resources.petals + S.rates.pps*dt);
}
function doOffline(){
  const now=Date.now(); const diff=Math.max(0,(now-S.lastTick)/1000);
  if(diff>3){
    recompute();
    const gainE=S.rates.eps*diff, gainO=S.rates.ops*diff, gainF=S.rates.fps*diff, gainP=S.rates.pps*diff;
    tick(diff);
    S.offlineNote='Welcome back! You were away for '+Math.floor(diff)+'s and earned +'+fmt(gainE)+'✨, +'+fmt(gainO)+'💖, +'+fmt(gainF)+'🍓, +'+fmt(gainP)+'🌸';
    addLog(S.offlineNote);
  }
}
function costFor(base, scale, count){
  const tE = treeEffects();
  const mult = Math.pow(scale, count);
  const c = {};
  for(const k in base){
    c[k] = Math.ceil(base[k] * mult * (1 - (tE.discount||0)));
    if(S && S.capacity && S.capacity[k]){
      const cap80 = Math.floor(S.capacity[k]*0.8);
      if(c[k] > cap80) c[k] = cap80;
    }
  }
  return c;
}
function canAfford(cost){ for(const k in cost){ if((S.resources[k]||0)<cost[k]) return false; } return true; }
function pay(cost){ for(const k in cost){ S.resources[k] = Math.max(0, (S.resources[k]||0)-cost[k]); } }
function renderStats(){
  document.getElementById('energy').textContent = fmt(S.resources.energy);
  document.getElementById('ore').textContent = fmt(S.resources.ore);
  document.getElementById('food').textContent = fmt(S.resources.food);
  document.getElementById('petals').textContent = fmt(S.resources.petals);
  document.getElementById('eps').textContent = '+'+fmt(S.rates.eps)+'/s';
  document.getElementById('ops').textContent = '+'+fmt(S.rates.ops)+'/s';
  document.getElementById('fps').textContent = '+'+fmt(S.rates.fps)+'/s';
  document.getElementById('pps').textContent = '+'+fmt(S.rates.pps)+'/s';
  document.getElementById('colonists').textContent = S.colonists.count + ' / ' + S.colonists.housing;
  document.getElementById('morale').textContent = 'happiness: ' + (S.colonists.morale*100).toFixed(0) + '%';
  const ePct=(S.resources.energy/S.capacity.energy)*100, oPct=(S.resources.ore/S.capacity.ore)*100, fPct=(S.resources.food/S.capacity.food)*100, pPct=(S.resources.petals/S.capacity.petals)*100;
  document.getElementById('batteryFill').style.width=Math.min(100,ePct)+'%';
  document.getElementById('storeFill').style.width=Math.min(100,oPct)+'%';
  document.getElementById('siloFill').style.width=Math.min(100,fPct)+'%';
  document.getElementById('petalFill').style.width=Math.min(100,pPct)+'%';
  document.getElementById('capText').textContent = fmt(S.resources.energy)+' / '+fmt(S.capacity.energy);
  document.getElementById('storeText').textContent = fmt(S.resources.ore)+' / '+fmt(S.capacity.ore);
  document.getElementById('siloText').textContent = fmt(S.resources.food)+' / '+fmt(S.capacity.food);
  document.getElementById('petalText').textContent = fmt(S.resources.petals)+' / '+fmt(S.capacity.petals);
  const preview=prestigeGain(); document.getElementById('prestigeGain').textContent=fmt(preview);
  document.getElementById('inspiration').textContent=fmt(S.inspiration);
  document.getElementById('inspBoost').textContent=(S.inspiration*2).toFixed(0);
  document.getElementById('inspirationStat').textContent=fmt(S.inspiration);
  document.getElementById('hlHeader').textContent=fmt(S.inspiration);
  const req = prestigeReq();
  document.getElementById('reqEnergy').textContent = fmt(req.energy);
  document.getElementById('reqOre').textContent = fmt(req.ore);
  document.getElementById('reqFood').textContent = fmt(req.food);
  document.getElementById('reqPetals').textContent = fmt(req.petals);
}
function renderBuilds(){
  const list=document.getElementById('buildList'); list.innerHTML='';
  for(const [name,b] of Object.entries(S.buildings)){
    const nextCost = costFor(b.baseCost, b.costScale, b.count);
    const el = document.createElement('div'); el.className='build-item';
    el.innerHTML = '<div class="left"><div><div><b>'+name+'</b> <span class="count">x'+b.count+'</span></div><div class="small">Cost: '+Object.entries(nextCost).map(([k,v])=>fmt(v)+' '+icon(k)).join(' • ')+'</div><div class="small">'+prodText(b.prod)+'</div></div></div><button class="btn">Build</button>';
    const btn = el.querySelector('button');
    const refreshBtn = ()=>{ const nc = costFor(b.baseCost, b.costScale, b.count); btn.className='btn '+(canAfford(nc)?'good':''); };
    refreshBtn();
    btn.onclick=()=>{ const nc = costFor(b.baseCost, b.costScale, b.count); if(!canAfford(nc)) return; pay(nc); b.count+=1; if(name==='Snuggle Hall'){ S.colonists.housing+=2; } addLog('Built '+name+'.'); recompute(); renderStats(); refreshBtn(); save(); };
    el.dataset.refresh='1';
    list.appendChild(el);
  }
}
function upgradeText(e){ const parts=[]; if(e.energyMult) parts.push('+'+Math.round(e.energyMult*100)+'% ✨'); if(e.oreMult) parts.push('+'+Math.round(e.oreMult*100)+'% 💖'); if(e.foodMult) parts.push('+'+Math.round(e.foodMult*100)+'% 🍓'); if(e.petalsMult) parts.push('+'+Math.round(e.petalsMult*100)+'% 🌸'); if(e.capAll) parts.push('+'+Math.round(e.capAll*100)+'% capacity'); if(e.tapMult) parts.push('+'+Math.round(e.tapMult*100)+'% tap'); if(e.moraleFloor) parts.push('+'+Math.round(e.moraleFloor*100)+'% happiness floor'); return parts.join(' • '); }
function tier1Maxed(){
  let ok=true;
  for(const [name,u] of Object.entries(S.upgrades)){
    if(name.includes('(T2)')) continue;
    if(u.level < u.max){ ok=false; break; }
  }
  return ok;
}
function renderUpgrades(){
  const list=document.getElementById('upgradeList'); list.innerHTML='';
  const showT2 = tier1Maxed();
  for(const [name,u] of Object.entries(S.upgrades)){
    const isT2 = name.includes('(T2)');
    if(isT2 && !showT2) continue;
    const lv=u.level, tE=treeEffects();
    const costObj=Object.fromEntries(Object.entries(u.baseCost).map(([k,v])=>{
      let val = Math.ceil(v*Math.pow(u.scale,lv)*(1-(tE.discount||0)));
      if(S && S.capacity && S.capacity[k]){
        const cap80 = Math.floor(S.capacity[k]*0.8);
        if(val>cap80) val = cap80;
      }
      return [k,val];
    }));
    const maxed=lv>=u.max;
    const el=document.createElement('div'); el.className='build-item';
    el.innerHTML='<div class="left"><div><div><b>'+name+'</b> <span class="count">Lv '+lv+'/'+u.max+'</span></div><div class="small">'+upgradeText(u.effect)+'</div><div class="small">Cost: '+Object.entries(costObj).map(([k,v])=>fmt(v)+' '+icon(k)).join(' • ')+'</div></div></div><button class="btn" '+(maxed?'disabled':'')+'>Upgrade</button>';
    const btn = el.querySelector('button');
    const refreshBtn = ()=>{
      const lvNow = u.level;
      const nowCost=Object.fromEntries(Object.entries(u.baseCost).map(([k,v])=>{
        let val = Math.ceil(v*Math.pow(u.scale,lvNow)*(1-(tE.discount||0)));
        if(S && S.capacity && S.capacity[k]){
          const cap80 = Math.floor(S.capacity[k]*0.8);
          if(val>cap80) val = cap80;
        }
        return [k,val];
      }));
      btn.className='btn '+((!maxed && canAfford(nowCost))?'good':'');
    };
    refreshBtn();
    btn.onclick=()=>{
      if(maxed) return;
      const lvNow = u.level;
      const nowCost=Object.fromEntries(Object.entries(u.baseCost).map(([k,v])=>{
        let val = Math.ceil(v*Math.pow(u.scale,lvNow)*(1-(tE.discount||0)));
        if(S && S.capacity && S.capacity[k]){
          const cap80 = Math.floor(S.capacity[k]*0.8);
          if(val>cap80) val = cap80;
        }
        return [k,val];
      }));
      if(!canAfford(nowCost)) return;
      pay(nowCost); u.level+=1; addLog('Upgraded '+name+' to Lv '+u.level+'.'); recompute(); renderStats(); refreshBtn(); save(); renderUpgrades();
    };
    el.dataset.refresh='1';
    list.appendChild(el);
  }
}
function renderTree(){
  const list = document.getElementById('treeList'); list.innerHTML='';
  Object.keys(TREE_DEFS).forEach(name=>{
    const def=TREE_DEFS[name], lv=(S.tree.levels[name]||0), maxed=(lv>=def.max);
    const cost=Math.ceil(def.baseCost * Math.pow(def.scale, lv));
    const prereq = def.prereq ? ('Requires: '+def.prereq) : 'No prerequisite';
    const el = document.createElement('div'); el.className='build-item';
    el.innerHTML = '<div class="left"><div><div><b>'+name+'</b> <span class="count">Lv '+lv+'/'+def.max+'</span></div><div class="small">'+def.desc+'</div><div class="small">'+prereq+'</div><div class="small">Cost: '+cost+' 💞 Heartlight</div></div></div><button class="btn '+((!maxed && S.inspiration>=cost)?'good':'')+'" '+(maxed?'disabled':'')+'>Buy</button>';
    el.querySelector('button').onclick=()=>buyNode(name);
    list.appendChild(el);
  });
}
function renderLog(){ document.getElementById('log').textContent = S.log.join('\n'); }
function renderAll(){ recompute(); renderStats(); renderBuilds(); renderUpgrades(); renderTree(); renderLog(); checkWinCondition(); }
function bindTap(){
  const tapBtn = document.getElementById('tapBtn');
  let lastTap = 0;
  function doTap(){
    if(S.won) return;
    const now=Date.now(); if(now-lastTap<60) return; lastTap=now;
    const mult = totalMult();
    const gain = (1 + mult.tapAdd) * (mult.tapMult);
    S.resources.energy = Math.min(S.capacity.energy, S.resources.energy + gain);
    tapBtn.animate([{transform:'scale(1)'},{transform:'scale(0.97)'},{transform:'scale(1)'}],{duration:120});
    renderStats(); save();
  }
  tapBtn.addEventListener('click', doTap, {passive:true});
  tapBtn.addEventListener('touchstart', (e)=>{e.preventDefault(); doTap();}, {passive:false});
}
function randomBubblePos(el){
  const pad = 24;
  const w = Math.max(200, window.innerWidth*0.2);
  const x = Math.floor(Math.random()*(window.innerWidth - pad*2 - w)) + pad;
  const y = Math.floor(Math.random()*(window.innerHeight - 180)) + 60;
  el.style.left = x+'px';
  el.style.top  = y+'px';
}
function showBubble(text){
  const linesCommon=["Today smells like sunshine ☀️","Snack stash is organized 🍓","I watered the window plants 🌱","I hummed our song quietly 🎵","Every sparkle feels like a tiny hug ✨","I kept a spot warm for you 🧣","I folded blanket forts just right 🏕️","I traced hearts in the foggy glass 💗","I found a shell shaped like a heart 🐚","The island wind sounds cozy tonight 🌬️","I practiced my happy dance 💃","I brewed pretend coffee for us ☕","I polished charm stones until they smiled 💖","I wrote your name with petals 🌸","I made a wish for gentle days 🌟","I drew windows so the sun finds us 🪟","I stacked jars in rainbow order 🌈","I kept the kettle whistling for you ☕","I saved a seat under the softest cloud ☁️","My paws are toasty and ready 🐾","I packed extra snacks just in case 🍪","Our little island feels brave today 🏝️","I practiced saying 'I love you' perfectly 💌","I found a shortcut through the meadows 🌼","I learned a new cuddle technique 🤗","I kept the lantern glowing for you 🏮","We’re getting really good at this 💪","Time moves softer when you are here ⏳","I pet the shy flowers so they'd bloom 🌷","Your laugh is my favorite weather forecast 🌦️","I dusted off the dream shelf ✨","The pantry smells like sugar clouds 🍬","I tuned the wind chimes to happy 🔔","I wrote a tiny poem on a leaf 🍃","The night lights are blinking for us 🌌","I marked the path back home 🗺️","I stitched tiny hearts on the pillows 🧵","I put friendship bracelets on the jars 🧿","Our map keeps drawing itself to you 🧭","I lined up boots for the next adventure 🥾","I saved a sunrise for later 🌅","I counted cuddles like constellations ✨","Every charm hums your name 💖","Petals follow me when I think of you 🌸","I practiced whispering 'always' 🌙","The pantry giggled; I think it likes us 🍓","I pressed a flower just for you 🌼","I knitted time into a scarf 🧶","I set two cups—one for you, one for me ☕","I kept the window seat warm 🪟💗","I tucked a note into the breeze 💌"];
  const linesRare=["I will find my Gregory, and he will be so loved 💞","Love is the quest, and you are the treasure 🗺️💗","In every quiet, I hear 'I’m here'—and it’s you.","If hearts were lanterns, mine would point to you 🔥","I learned the shape of forever by tracing your hand.","Home isn’t a place; it’s us. Always."];
  const el = document.getElementById('bubble');
  if(!text){
    const roll=Math.random();
    text = (roll<0.06? linesRare[Math.floor(Math.random()*linesRare.length)] : linesCommon[Math.floor(Math.random()*linesCommon.length)]);
  }
  el.textContent=text;
  randomBubblePos(el);
  el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'), 3800);
}
function bubbleIntervalMs(){
  const base = 35000 + Math.random()*20000;
  const tE = treeEffects();
  const colFactor = 1 + (S.colonists.count||0)*0.08;
  const speed = (tE.questSpeedMult||1) * colFactor;
  return Math.max(6000, base / speed);
}
let nextBubbleAt = Date.now() + 8000;
function scheduleNextQuest(announce){
  const tE = treeEffects();
  const baseMs = 60000 + Math.random()*20000;
  const colFactor = 1 + (S.colonists.count||0)*0.10;
  const speed = (tE.questSpeedMult||1) * colFactor;
  S.nextQuestAt = Date.now() + Math.floor(baseMs / speed);
  S.questActive = true;
  if(announce){
    const starts=["Michelle sets out on a quest, pockets full of hope 💖","A Michelle heads out, whispering a promise to return soon 🌬️","With a bright glance back, Michelle leaves to seek love and shiny things ✨","Our brave Michelle steps off the path, heart pointing toward Gregory 💗","Michelle laces her boots and goes questing for charm and answers 🥾"];
    const line = starts[Math.floor(Math.random()*starts.length)];
    addLog(line);
    showBubble(line);
  }
}
function maybeQuest(){
  if(S.won) return;
  const now = Date.now();
  if(!S.questActive && now >= (S.nextQuestAt||0)){
    scheduleNextQuest(true);
  }
  if(S.questActive && now >= (S.nextQuestAt||0)){
    const tE = treeEffects();
    const rMult = (tE.questRewardMult||1);
    const e = Math.floor( (S.capacity.energy* (0.02 + Math.random()*0.03)) * rMult );
    const o = Math.floor( (S.capacity.ore   * (0.02 + Math.random()*0.03)) * rMult );
    const f = Math.floor( (S.capacity.food  * (0.02 + Math.random()*0.03)) * rMult );
    const p = Math.floor( (S.capacity.petals* (0.02 + Math.random()*0.03)) * rMult );
    S.resources.energy = Math.min(S.capacity.energy, S.resources.energy + e);
    S.resources.ore    = Math.min(S.capacity.ore,    S.resources.ore    + o);
    S.resources.food   = Math.min(S.capacity.food,   S.resources.food   + f);
    S.resources.petals = Math.min(S.capacity.petals, S.resources.petals + p);
    const returns=["Michelle returns from her quest, cheeks rosy and arms full of wonder 🎒","She’s back from the path, carrying treasures and a story to tell ✨","Michelle comes home smiling—love and luck clinging to her coat 💞","Boots dusty, heart bright—Michelle returns from the quest 🥾💖","Michelle returns, whispering, 'I always find my way back to you.'"];
    const ret = returns[Math.floor(Math.random()*returns.length)];
    addLog(ret + ' +' + fmt(e)+'✨ +' + fmt(o)+'💖 +' + fmt(f)+'🍓 +' + fmt(p)+'🌸');
    showBubble(ret);
    S.questActive = false;
    scheduleNextQuest(true);
    save();
  }
}
function maybeBubble(){
  if(S.won) return;
  const now = Date.now();
  if(now >= nextBubbleAt){
    showBubble();
    nextBubbleAt = now + bubbleIntervalMs();
  }
}
function prestigeReq(){
  const scale = Math.pow(1.25, (S.prestigeCount||0));
  return { energy: Math.floor(10000 * scale), ore: Math.floor(5000 * scale), food: Math.floor(5000 * scale), petals: Math.floor(3000 * scale) };
}
function prestigeGain(){ const tE=treeEffects(); const total=S.resources.energy+S.resources.ore+S.resources.food+S.resources.petals; const base=Math.floor(Math.sqrt(total)/45); const mult=1+(tE.inspBonus||0); return Math.floor(base*mult); }
function tryPrestige(){
  if(S.won) return;
  const req=prestigeReq();
  if(!canAfford(req)){ addLog('Not enough resources to send the Love Beacon.'); return; }
  const gain=prestigeGain(); pay(req);
  const keepLevels = JSON.parse(JSON.stringify(S.tree.levels||{}));
  const keptInsp = S.inspiration + gain;
  const nextCount = (S.prestigeCount||0) + 1;
  S = structuredClone(defaultState);
  S.tree.levels = keepLevels;
  S.inspiration = keptInsp;
  S.prestigeCount = nextCount;
  scheduleNextQuest(true);
  addLog('Love Beacon sent! +'+gain+' Heartlight (total '+S.inspiration+'). Requirements increased for next time.');
  save(); renderAll();
}
function nodeCost(name){ const def = TREE_DEFS[name], lv = (S.tree.levels[name]||0); return Math.ceil(def.baseCost * Math.pow(def.scale, lv)); }
function canBuyNode(name){ const def = TREE_DEFS[name], lv = (S.tree.levels[name]||0); if(lv>=def.max) return false; if(def.prereq && (S.tree.levels[def.prereq]||0)<=0) return false; return S.inspiration >= nodeCost(name); }
function buyNode(name){
  if(!canBuyNode(name)) return;
  const cost = nodeCost(name);
  S.inspiration -= cost;
  S.tree.levels[name] = (S.tree.levels[name]||0) + 1;
  addLog('Prestige node purchased: '+name+' (Lv '+S.tree.levels[name]+').');
  recompute(); renderAll(); save();
}
function allTreeMaxed(){
  for(const k in TREE_DEFS){
    const d=TREE_DEFS[k]; const lv=(S.tree.levels[k]||0);
    if(lv<d.max) return false;
  }
  return true;
}
function buildEpilogue(){
  const mic = S.colonists.count;
  const insp = S.inspiration;
  const runs = S.prestigeCount;
  return "When every branch of the Bond Tree blossomed, the Michelle’s found their Gregory’s.\n\nThey carried home sparkles and charms, but the truest treasure was the way Gregory looked at Michelle—with the kind of love that glows in quiet rooms and busy mornings alike.\n\n"+
         "Together they counted "+mic+" happy companions, held "+insp+" heartlights, and finished "+runs+" beacons—each one a promise kept.\n\nHere, on this gentle island, they lived softly and bravely, always finding their way back to one another. Happily ever after.";
}
function checkWinCondition(){
  if(S.won) return;
  if(allTreeMaxed()){
    S.won = true;
    const overlay = document.getElementById('ending');
    const txt = document.getElementById('endingText');
    txt.textContent = buildEpilogue();
    const blob = new Blob([txt.textContent], {type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const saver = document.getElementById('saveStoryBtn');
    saver.href = url;
    overlay.style.display='flex';
    addLog('The Bond Tree is complete. A soft story fills the sky… 💞');
    save();
  }
}
function switchPanel(showId){
  const panels=['panelBuild','panelUpg','panelPrestige','panelTree','panelSettings'];
  panels.forEach(id=>{ document.getElementById(id).style.display = (id===showId)?'block':'none'; });
  const tabs=['tabBuild','tabUpg','tabPrestige','tabTree','tabSettings'];
  tabs.forEach((id,i)=>{ const el=document.getElementById(id); el.classList.toggle('active', panels[i]===showId); });
}
function bindUI(){
  document.getElementById('tabBuild').onclick = ()=>switchPanel('panelBuild');
  document.getElementById('tabUpg').onclick = ()=>switchPanel('panelUpg');
  document.getElementById('tabPrestige').onclick = ()=>switchPanel('panelPrestige');
  document.getElementById('tabTree').onclick = ()=>switchPanel('panelTree');
  document.getElementById('tabSettings').onclick = ()=>switchPanel('panelSettings');
  document.getElementById('saveBtn').onclick = ()=>save(true);
  document.getElementById('wipeBtn').onclick = ()=>{ if(confirm('Wipe save and restart?')) reset(); };
  document.getElementById('prestigeBtn').onclick = tryPrestige;
  document.getElementById('exportBtn').onclick = async ()=>{
    try{ await navigator.clipboard.writeText(localStorage.getItem(SAVE_KEY)||''); addLog('Save copied to clipboard.'); }
    catch(e){ addLog('Could not copy automatically. Long-press to select and copy from Moments below.'); }
  };
  document.getElementById('hireBtn').onclick = ()=>{
    if(S.won) return;
    const cost = { food: 50 };
    if(S.colonists.count >= S.colonists.housing){ addLog('No housing! Build more Snuggle Halls.'); return; }
    if(!canAfford(cost)){ addLog('Not enough 🍓 Treats to invite.'); return; }
    pay(cost); S.colonists.count += 1; addLog('A new Michelle joined the island! 🐾'); recompute(); renderStats(); save();
  };
  document.getElementById('restartBtn').onclick = ()=>{ if(confirm('Start a brand new journey?')){ reset(); document.getElementById('ending').style.display='none'; } };
  bindTap();
}
function renderLog(){ document.getElementById('log').textContent = S.log.join('\n'); }
function renderAll(){ recompute(); renderStats(); renderBuilds(); renderUpgrades(); renderTree(); renderLog(); checkWinCondition(); }
let uiPulse = 0;
let acc=0,last=performance.now();
function loop(now){
  const dt=(now-last)/1000; last=now; acc+=dt; const step=0.1;
  while(acc>=step){ tick(step); acc-=step; }
  renderStats();
  uiPulse += dt;
  if (uiPulse >= 0.5){
    renderBuilds();
    renderUpgrades();
    maybeQuest();
    maybeBubble();
    uiPulse = 0;
  }
  requestAnimationFrame(loop);
}
function renderInitial(){
  load(); doOffline(); renderAll(); bindUI(); scheduleNextQuest(true); save();
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js'); }
  addLog('Welcome to Michelle’s Colony — v'+VERSION+' loaded.');
}
window.addEventListener('load', ()=>{ renderInitial(); requestAnimationFrame(loop); });
</script>
</body>
</html>
